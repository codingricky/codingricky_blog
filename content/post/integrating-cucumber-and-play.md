+++
author = "Ricky Yim"
categories = ["Play!", "Play", "Testing", "Cucumber", "Behaviour Driven Development", "BDD"]
date = 2013-10-13T01:00:00Z
description = ""
draft = false
slug = "integrating-cucumber-and-play"
tags = ["Play!", "Play", "Testing", "Cucumber", "Behaviour Driven Development", "BDD"]
title = "Integrating Cucumber and Play"
aliases = [
    "/integrating-cucumber-and-play/"
]
+++

<p>The default application generated by <a href="http://www.playframework.com">Play</a> has examples of unit and integration tests, however it does not demonstrate how to integrate in any Behaviour Driven Development (BDD) frameworks. The value of a BDD framework like <a href="http://cukes.info">Cucumber</a> is extremely high when attempting to achieve strong collaboration between various stakeholders like Developers and Business Analysts. This post will show you how to get up and running with Cucumber and Play. The example uses Play 2.2.0 and Java.</p>

<ol>
<li>
<p> Assuming you have already setup a vanilla Play application already, the first thing you need to do is add the dependencies for Cucumber. Go to your <b>build.sbt</b> file and add in the dependencies for Cucumber. In this post, we will be using <a href="https://github.com/cucumber/cucumber-jvm">cucumber-jvm</a>, along with the <b>cucumber-junit</b> launcher. </p>


<pre class="prettyprint linenums">
name := "sample-with-cucumber"

version := "1.0-SNAPSHOT"

libraryDependencies ++= Seq(
  javaJdbc,
  javaEbean,
  cache
  "info.cukes" % "cucumber-java" % "1.1.5" % "test",
  "info.cukes" % "cucumber-junit" % "1.1.5" % "test"
 )     

play.Project.playJavaSettings

</pre>
</li>
<li>
<p>Let's create a directory to contain our feature files. I generally put my features in a <b>features</b> directory in the root of my application.</p>

<pre class="prettyprint linenums">
$ mkdir features
</pre>
</li>
<li>
<p>For this directory to be picked up, we need to add it into the classpath when running tests. This is a change we need to make to the <b>build.sbt</b> file.

<pre class="prettyprint linenums">
name := "sample-with-cucumber"

version := "1.0-SNAPSHOT"

libraryDependencies ++= Seq(
  javaJdbc,
  javaEbean,
  cache
  "info.cukes" % "cucumber-java" % "1.1.5" % "test",
  "info.cukes" % "cucumber-junit" % "1.1.5" % "test"
 )     

play.Project.playJavaSettings

unmanagedResourceDirectories in Test <+= baseDirectory( _ / "features" )

</pre>

</li>
<li> <p>To keep everything simple, let's create a very basic feature file. All this will do is go to the landing page and assert the title of the page is equal to the text "Cucumber".</p>

<p>Create a file <b>features/example.feature</b> containing the following contents.</p>

<pre class="prettyprint linenums">
Feature: Testing Cucumber Integration

  Scenario: Cucumber Integration
    Given I have setup Play
    When I go to the landing page
    Then the title should be "Cucumber"

</pre>


</li>

<li>
<p>To get this running, we need a class that is annotated with the Cucumber JUnit runner annotation. So create a class called <b>test/RunCucumber.java</b> with the following contents. The "pretty" flag is optional, but I much prefer that output.  </p>

<pre class="prettyprint linenums">
import cucumber.api.junit.Cucumber;
import org.junit.runner.RunWith;

@RunWith(Cucumber.class)
@Cucumber.Options(format = {"pretty"})
public class RunCucumber {
}
</pre>  
</li>

<li>
<p>Now let's checkpoint what we have done so far. If everything is working, we should be able to run Cucumber and it should complain that we are missing step definitions.</p>

<pre class="prettyprint">
$ play test
</pre> 

<pre class="prettyprint">
...
You can implement missing steps with the snippets below:

@Given("^I have setup Play$")
public void I_have_setup_Play() throws Throwable {
    // Express the Regexp above with the code you wish you had
    throw new PendingException();
}

@When("^I go to the landing page$")
public void I_go_to_the_landing_page() throws Throwable {
    // Express the Regexp above with the code you wish you had
    throw new PendingException();
}

@Then("^the title should be \"([^\"]*)\"$")
public void the_title_should_be(String arg1) throws Throwable {
    // Express the Regexp above with the code you wish you had
    throw new PendingException();
}

</pre>

</li>
<li>
<p>To get the scenario to pass, we need to first put a startup hook in place to initialize our server and test browser. Cucumber does provide a <b>@Before</b> hook but this is executed before each and every scenario. We only want to initialize our server and browser once before the very first scenario, so we need to add some state to manage this ourselves.</p>

<p>Create a <b>test/GlobalHooks.java</b> class and add the following contents.</p>


<pre class="prettyprint linenums">
import cucumber.api.java.Before;
import play.test.TestBrowser;
import play.test.TestServer;
import static play.test.Helpers.*;

public class GlobalHooks {
    public static int PORT = 3333;
    public static TestBrowser TEST_BROWSER;
    private static TestServer TEST_SERVER;
    private static boolean initialised = false;

    @Before
    public void before() {
        if (!initialised) {
            TEST_SERVER = testServer(PORT, fakeApplication(inMemoryDatabase()));
            TEST_BROWSER = testBrowser(HTMLUNIT, PORT);
            start(TEST_SERVER);
            initialised = true;
        }
    }

}
</pre>  

<p>There's also no shutdown hook in Cucumber, so we need to add the clean up of the server and browser into the JVM shutdown hook. <p>

<pre class="prettyprint linenums">
import cucumber.api.java.Before;
import play.test.TestBrowser;
import play.test.TestServer;
import static play.test.Helpers.*;

public class GlobalHooks {
    public static int PORT = 3333;
    public static TestBrowser TEST_BROWSER;
    private static TestServer TEST_SERVER;
    private static boolean initialised = false;

    @Before
    public void before() {
        if (!initialised) {
            TEST_SERVER = testServer(PORT, fakeApplication(inMemoryDatabase()));
            TEST_BROWSER = testBrowser(HTMLUNIT, PORT);
            start(TEST_SERVER);
            initialised = true;
            Runtime.getRuntime().addShutdownHook(new Thread() {
                @Override
                public void run() {
                    TEST_BROWSER.quit();
                    TEST_SERVER.stop();
                }
            });
        }
    }
}
</pre>  
</li>

<li>
<p>Now we should be able to implement our steps. So create a <b>test/Steps.java</b> file. For the moment, we will just statically reference our <b>TEST_BROWSER</b>. There is a better way to inject this dependency in, which I will cover later. </p>

<pre class="prettyprint linenums">
import cucumber.api.java.en.Given;
import cucumber.api.java.en.Then;
import cucumber.api.java.en.When;
import static org.fest.assertions.Assertions.assertThat;

public class Steps {
    @Given("^I have setup Play$")
    public void I_have_setup_Play() throws Throwable {
    }

    @When("^I go to the landing page$")
    public void I_go_to_the_landing_page() throws Throwable {
        GlobalHooks.TEST_BROWSER.goTo("http://localhost:" + GlobalHooks.PORT);
    }

    @Then("^the title should be \"([^\"]*)\"$")
    public void the_title_should_be(String title) throws Throwable {
        assertThat(GlobalHooks.TEST_BROWSER.title()).isEqualTo(title);
    }
}
</pre>

</li>
<li><p>We should now be in a position to rerun this. The steps should be found however the title of the page will not be "Cucumber" resulting in a failure. </p>

<pre class="prettyprint">
$ play test
</pre>

<pre class="prettyprint">
...
0m[error] Test Scenario: Cucumber Integration failed: expected:<'[Cucumber]'> but was:<'[Welcome to Play]'>
...
</pre>
</li>
<li>
<p>Let's correct the title of the page and rerun the test.</p>

<p>Navigate to <b>app/views/index.scala.html</b>. Update the title of the page to be "Cucumber"</p>

<pre class="prettyprint linenums">
@(message: String)

@main("Cucumber") {
    @play20.welcome(message, style = "Java")
}
</pre>
</li>
<li>
<p>Rerun the test and it should succeed.</p>

<pre class="prettyprint">
1 Scenarios (1 passed)
3 Steps (3 passed)
0m3.544s
</pre>

</li>
<li><p>The last series of changes will be around integrating with <a href="http://code.google.com/p/google-guice/">Guice</a> so we can inject our dependencies into the Steps. This will remove the need to directly reference the test browser.</p>

<p>Go back into the <b>build.sbt</b> file and add the dependencies for <b>guice</b> as well as <b>cucumber-guice</b>, which provides the binding for guice into cucumber.</p>

<pre class="prettyprint linenums">
name := "sample-with-cucumber"

version := "1.0-SNAPSHOT"

libraryDependencies ++= Seq(
  javaJdbc,
  javaEbean,
  cache,
  "com.google.inject" % "guice" % "3.0" % "test",
  "info.cukes" % "cucumber-guice" % "1.1.5" % "test",
  "info.cukes" % "cucumber-java" % "1.1.5" % "test",
  "info.cukes" % "cucumber-junit" % "1.1.5" % "test"
 )     

play.Project.playJavaSettings

unmanagedResourceDirectories in Test <+= baseDirectory( _ / "features" )
</pre> 
</li>

<li>
<p>Define a <b>test/CucumberModule.java</b> class which will setup our bindings.</p>

<pre class="prettyprint linenums">
import com.google.inject.AbstractModule;
import com.google.inject.name.Names;
import play.test.TestBrowser;
import play.test.TestServer;
import static play.test.Helpers.*;

public class CucumberModule extends AbstractModule {

    private static int PORT = 3333;
    private TestServer testServer = testServer(PORT, fakeApplication(inMemoryDatabase()));
    private TestBrowser testBrowser = testBrowser(HTMLUNIT, PORT);

    @Override
    protected void configure() {
        bind(TestBrowser.class).toInstance(testBrowser);
        bind(TestServer.class).toInstance(testServer);
        bind(Integer.class).annotatedWith(Names.named("PORT")).toInstance(PORT);
    }
}

</pre>

<p>Now change <b>test/GlobalHooks.java</b> to be dependency injected.</p>

<pre class="prettyprint linenums">
import com.google.inject.Inject;
import cucumber.api.java.Before;
import play.test.TestBrowser;
import play.test.TestServer;
import static play.test.Helpers.*;

public class GlobalHooks {
    @Inject
    private TestBrowser testBrowser;
    @Inject
    private TestServer testServer;
    private static boolean initialised = false;

    @Before
    public void before() {
        if (!initialised) {
            start(testServer);
            initialised = true;
            Runtime.getRuntime().addShutdownHook(new Thread() {
                @Override
                public void run() {
                    testBrowser.quit();
                    testServer.stop();
                }
            });
        }
    }
}
</pre>

<p>Change <b>test/Steps.java</b> to be dependency injected.</p>

<pre class="prettyprint linenums">
import com.google.inject.Inject;
import com.google.inject.name.Named;
import cucumber.api.java.en.Given;
import cucumber.api.java.en.Then;
import cucumber.api.java.en.When;
import play.test.TestBrowser;
import static org.fest.assertions.Assertions.assertThat;

public class Steps {
    @Inject
    private TestBrowser testBrowser;

    @Inject
    @Named("PORT")
    private Integer port;

    @Given("^I have setup Play$")
    public void I_have_setup_Play() throws Throwable {
    }

    @When("^I go to the landing page$")
    public void I_go_to_the_landing_page() throws Throwable {
        testBrowser.goTo("http://localhost:" + port);
    }

    @Then("^the title should be \"([^\"]*)\"$")
    public void the_title_should_be(String title) throws Throwable {
        assertThat(testBrowser.title()).isEqualTo(title);
    }
}
</pre>
</li>

<li><p>Lastly add a <b>features.cucumber-guice.properties</b> file to refer to our module. So this file should have the following contents.</p>

<pre class="prettyprint linenums">
guiceModule=CucumberModule
</pre>

</li>

<li><p>Now if we rerun everything, then the test should still pass which will prove that everything has been setup correctly.</p>

<pre class="prettyprint linenums">
$ play test
</pre>



<pre class="prettyprint">
Feature: Testing Cucumber Integration

  Scenario: Cucumber Integration        # example.feature:3
    Given I have setup Play             # Steps.I_have_setup_Play()
    When I go to the landing page       # Steps.I_go_to_the_landing_page()
    Then the title should be "Cucumber" # Steps.the_title_should_be(String)

1 Scenarios (1 passed)
3 Steps (3 passed)
0m2.092s
</pre>
</li>
</ol>

<p>So this posting has taken you through the steps required to integrate Cucumber and Play. It also has shown you how to integrate Guice into your Cucumber Steps to keep your code cleaner. An example of this sample application can be found <a href="https://github.com/codingricky/sample-play-with-cucumber">here</a>.